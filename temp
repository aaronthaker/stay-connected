Sub GenerateReports()
    Dim wsRaw As Worksheet, wsPwC As Worksheet, wsPwC7Days As Worksheet, wsSample As Worksheet, wsParams As Worksheet
    Dim lastRow As Long, lastRowPwC As Long, lastRowPwC7Days As Long
    Dim closingDate As Date, samplePercent As Double
    Dim rng As Range, cell As Range
    Dim dict As Object
    Dim sampleSize As Integer
    Dim i As Integer, rowNum As Integer
    Dim filteredData As Range

    ' Set worksheets
    Set wsRaw = ThisWorkbook.Sheets("Raw Data")
    Set wsPwC = ThisWorkbook.Sheets("Closed by PwC")
    Set wsPwC7Days = ThisWorkbook.Sheets("Closed by PwC Last 7 Days")
    Set wsSample = ThisWorkbook.Sheets("Random Sample")
    Set wsParams = ThisWorkbook.Sheets("Params")

    ' Find last row in Raw Data
    lastRow = wsRaw.Cells(wsRaw.Rows.Count, 1).End(xlUp).Row

    ' Clear previous data
    wsPwC.Cells.Clear
    wsPwC7Days.Cells.Clear
    wsSample.Cells.Clear

    ' Copy headers to new sheets
    wsRaw.Rows(1).Copy wsPwC.Rows(1)
    wsRaw.Rows(1).Copy wsPwC7Days.Rows(1)
    wsRaw.Rows(1).Copy wsSample.Rows(1)

    ' Filter for "Closed by PwC"
    Dim row As Integer
    row = 2
    For i = 2 To lastRow
        If (wsRaw.Cells(i, 9).Value = "Closed") And _
           ((wsRaw.Cells(i, 10).Value = "Initial Analysis") Or (wsRaw.Cells(i, 10).Value = "Enhanced Analysis")) And _
           (InStr(wsRaw.Cells(i, 8).Value, "Joseph Goldstein") > 0 Or InStr(wsRaw.Cells(i, 8).Value, "Sam Lodge") > 0) Then
           
            wsRaw.Rows(i).Copy wsPwC.Rows(row)
            row = row + 1
        End If
    Next i
    lastRowPwC = wsPwC.Cells(wsPwC.Rows.Count, 1).End(xlUp).Row

    ' Get date from Params C3
    closingDate = wsParams.Range("C3").Value

    ' Filter for "Closed by PwC Last 7 Days"
    row = 2
    For i = 2 To lastRowPwC
        If wsPwC.Cells(i, 15).Value <> "" Then
            If DateValue(Left(wsPwC.Cells(i, 15).Value, 10)) >= closingDate - 7 Then
                wsPwC.Rows(i).Copy wsPwC7Days.Rows(row)
                row = row + 1
            End If
        End If
    Next i
    lastRowPwC7Days = wsPwC7Days.Cells(wsPwC7Days.Rows.Count, 1).End(xlUp).Row

    ' Get sample percentage from Params C4
    samplePercent = wsParams.Range("C4").Value
    sampleSize = Application.WorksheetFunction.RoundDown((lastRowPwC7Days - 1) * samplePercent, 0)

    ' Random Sampling
    Set dict = CreateObject("Scripting.Dictionary")
    Do While dict.Count < sampleSize
        rowNum = Application.WorksheetFunction.RandBetween(2, lastRowPwC7Days)
        If Not dict.exists(rowNum) Then
            dict.Add rowNum, Nothing
            wsPwC7Days.Rows(rowNum).Copy wsSample.Rows(dict.Count + 1)
        End If
    Loop

    ' Cleanup
    Set wsRaw = Nothing
    Set wsPwC = Nothing
    Set wsPwC7Days = Nothing
    Set wsSample = Nothing
    Set wsParams = Nothing
    Set dict = Nothing

    MsgBox "Report Generation Complete!", vbInformation
End Sub